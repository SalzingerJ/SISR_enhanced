# Better Data for Satellite Super Resolution

This is the repo with support code for the paper

**Better Data for Satellite Super Resolution** <br>
NeurIPS 2025 [Workshop on Reliable ML from Unreliable Data](https://reliablemlworkshop.github.io/) <br>
Miguel Castells, Jules Salzinger, and Oliver Zendel <br>
[Austrian Institute of Technology Gmbh](https://www.ait.ac.at/) <br>

This work utilizes the S2*NAIP dataset from the paper \_Zooming Out on Zooming In: Advancing Super-Resolution for Remote Sensing* ([link](https://github.com/allenai/satlas-super-resolution)). We gratefully acknowledge their contributions.

This repository contains code to ensure the reproducibility of the experiments described in our paper, including:

- Pre-filtering of datapoints
- Downloading NIR bands for NAIP
- Dataset creation pipeline
- Manual correction of worst pairs

---

## Installation

1. Clone this repo
2. Create a .env file (see template.env) and put it in the repo root folder
3. Build the Dockerfile using ```docker compose build ```

## Dataset creation

### Step 1 : Download data

- Download the [S2-NAIP dataset](https://github.com/allenai/satlas-super-resolution/?tab=readme-ov-file#data) from the satlas superresolution repository (all four parts of the train_urban_set and val_set).
- Extract archives so both ./train_urban_set and ./val_set are in the same root satlas data folder (set SATLAS_DATA_PATH to this folder in your .env)
- Build and execute the downloader using: <br>
  ```docker compose -f docker-compose-nair-nir.yml build``` and ```docker compose -f docker-compose-nair-nir.yml run satlas_naip_nir``` <br>
  Note: the downloader takes approx. 500h to complete the 1.1 million tiles due to bandwidth restrictions from MS planetary computer

### Step 2 : Pre-filter datapoints

Create a configuration file (config.json) specifying:

```yaml
{
  "naip_dir": "path/to/naip/directory",
  "s2_dir": "path/to/sentinel2/directory",
  "results_path": "path/to/file.json",
}
```

| Config Key     | Description                                        |
| -------------- | -------------------------------------------------- |
| `naip_dir`     | Path to the folder containing NAIP images.         |
| `s2_dir`       | Path to the folder containing Sentinel-2 images.   |
| `results_path` | Path to the JSON file where results will be saved. |

Then run the pre-filtering script:

```bash
python -m first_filtering.main -opt path/to/config.json
```

This generates a JSON file containing valid datapoints for dataset creation.

### Create the dataset

Prepare a configuration file specifying:

```yaml
{
  "rgb_dir": "/path/to/rgb/directory",
  "save_dir": "/path/to/save/directory",
  "nir_dir": "/path/to/nir/directory/naip",
  "data_path": "/path/to/file.json",
  "num_imgs_m1": 16, # Number of images after cloud removal (default in paper)
  "device": "cuda:0",
}
```

| Config Key    | Description                                                            |
| ------------- | ---------------------------------------------------------------------- |
| `rgb_dir`     | Path to the parent folder containing all Sentinel-2 and NAIP images.   |
| `save_dir`    | Path to the directory where output files will be saved.                |
| `nir_dir`     | Path to the folder containing NAIP NIR (Near-Infrared) images.         |
| `data_path`   | Path to the JSON file generated by the prefiltering step.              |
| `num_imgs_m1` | Number of images after cloud removal (default value as per the paper). |

Then run the dataset creation pipeline:

```bash
python -m pipeline_framework.main -opt path/to/config.json
```

### Manual Correction of Worst Pairs of the Test Set

We propose a manual correction process for the worst-performing pairs—those with the poorest inference results according to a chosen metric.

| Parameter            | Description                                                                                                                                      |
| -------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------ |
| `result_path`        | Path to the results directory                                                                                                                    |
| `metric_name`        | Metric to use (options: `"psnr_rgb"`, `"psnr_all"`, `"clip_rgb"`, `"ssim_rgb"`, `"ssim_all"`, `"lpips_rgb"`) — _Note: CLIP refers to Git-RSCLIP_ |
| `pipeline_directory` | Path to the directory where pipeline images are stored                                                                                           |
| `S2NAIP_directory`   | Path to the directory where S2NAIP images are stored                                                                                             |
| `nir_dir`            | Directory containing the NIR band of NAIP images                                                                                                 |
| `json_save_path`     | Path where the corrected results dictionary will be saved                                                                                        |

Once these parameters are set, you can begin the manual correction of pairs. The output is a dictionary mapping {unique_id/chip: chosen_index}, which can be used to overwrite the outputs of a first filtering experiment.

If no pairs are visually correct, the user may enter None as the index for that pair.

## ESRGAN

We use the ESRGAN used in [Satlas-Superesolution](https://github.com/allenai/satlas-super-resolution) paper but we extend the generation to the NIR band just by tweaking the config.
